<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OuchMyBrain — Summary</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        .upload-container {
            text-align: center;
            margin: 40px 0;
            padding: 30px;
            border: 2px dashed #3498db;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .btn {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        #fileInput { display: none; }
        #output {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            min-height: 100px;
            max-height: 70vh; /* allow scrolling within summary */
            overflow-y: auto;
            white-space: pre-wrap;
            text-align: left;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .section-title {
            margin-top: 24px;
            font-weight: 600;
            color: #2c3e50;
        }
        .ai-output h2, .ai-output h3 {
            margin: 12px 0 6px;
        }
    </style>
</head>
<body>
    <h1>Summary</h1>
    <div class="upload-container">
        <form id="uploadForm" enctype="multipart/form-data" onsubmit="return false;">
            <input type="file" id="fileInput" accept="application/pdf" multiple required />
            <button type="button" class="btn" id="uploadBtn">Choose PDFs</button>
        </form>
        <div style="margin-top:12px; font-size:14px; color:#2c3e50;">
            <strong>Selected:</strong> <span id="selectedCount">0</span> PDFs •
            <strong>Uploaded:</strong> <span id="uploadedCount">0</span>
        </div>
        <div style="margin-top:14px; display:flex; gap:10px; justify-content:center;">
            <a class="btn" href="/flashcards" style="text-decoration:none;">Open Flashcards</a>
            <a class="btn" href="/quiz" style="text-decoration:none;">Open Quiz</a>
        </div>
    </div>
    <div id="statusBar" style="display:none; margin-top:8px; padding:10px; border-radius:6px; background:#ecf5ff; color:#2c3e50; border:1px solid #cfe3ff; text-align:center;">
        Processing PDFs…
    </div>
    <div id="output">Choose one or more PDFs to generate basic summaries. The summary panel scrolls independently.</div>
    <script>
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const selectedCountEl = document.getElementById('selectedCount');
        const uploadedCountEl = document.getElementById('uploadedCount');
        const statusBar = document.getElementById('statusBar');
        let uploadedCount = 0;

        // Open picker on click
        uploadBtn.addEventListener('click', () => fileInput.click());

        // Handle selection and sequential uploads
        fileInput.addEventListener('change', async () => {
            const files = Array.from(fileInput.files || []);
            if (!files.length) return;
            selectedCountEl.textContent = String(files.length);

            const output = document.getElementById('output');
            output.innerHTML = '<h2 class="section-title">Summary</h2>';
            if (statusBar) { statusBar.style.display = 'block'; statusBar.textContent = 'Processing PDFs…'; }

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const progress = document.createElement('div');
                progress.style.margin = '8px 0';
                progress.textContent = `Uploading ${i + 1}/${files.length}: ${file.name}...`;
                output.appendChild(progress);

                try {
                    const fd = new FormData();
                    // Upload one file at a time to keep backend simple
                    fd.append('files', file, file.name);
                    const res = await fetch('/api/process', { method: 'POST', body: fd });
                    const data = await res.json().catch(() => ({ error: 'Invalid JSON' }));

                    progress.remove();

                    if (!res.ok) {
                        const errBox = document.createElement('div');
                        errBox.style.color = '#c0392b';
                        errBox.textContent = `${file.name}: ${data.error || 'Error while processing PDF.'}`;
                        output.appendChild(errBox);
                        continue;
                    }

                    // Persist source text (last one wins) for quiz page
                    if (data.source_text) {
                        try { sessionStorage.setItem('omb_text', data.source_text); } catch (e) {}
                        try { localStorage.setItem('omb_text', data.source_text); } catch (e) {}
                    }

                    // Append a basic summary block for this file
                    const block = document.createElement('div');
                    block.className = 'ai-output';
                    block.innerHTML = `
                        <h3 style="margin:8px 0 4px; color:#2c3e50;">${file.name}</h3>
                        <div>${data.result || '[No response]'}</div>
                        <hr style="margin:16px 0; border:none; border-top:1px solid #eee;">
                    `;
                    output.appendChild(block);

                    // Update uploaded counter
                    uploadedCount += 1;
                    uploadedCountEl.textContent = String(uploadedCount);
                } catch (err) {
                    progress.remove();
                    const errBox = document.createElement('div');
                    errBox.style.color = '#c0392b';
                    errBox.textContent = `${file.name}: Network error: ${err?.message || err}`;
                    output.appendChild(errBox);
                }
            }

            // Reset "Selected" since batch finished
            selectedCountEl.textContent = '0';
            fileInput.value = '';
            if (statusBar) { statusBar.style.display = 'none'; }

            // Add Take Quiz button (uses last uploaded text for questions)
            const actions = document.createElement('div');
            actions.style.marginTop = '16px';
            actions.style.textAlign = 'center';
            actions.innerHTML = '<button class="btn" id="takeQuizBtn">Take Quiz</button>';
            output.appendChild(actions);
            const takeQuizBtn = document.getElementById('takeQuizBtn');
            if (takeQuizBtn) {
                takeQuizBtn.addEventListener('click', () => {
                    window.location.href = '/quiz';
                });
            }
        });
    </script>
</body>
</html>